name: GoUpdate - Auto Update

on:
  push:
    branches:
      - main # Only for testing purposes, normal use is via schedule or manual dispatch
  schedule:
    - cron: '0 0 * * 1' # Weekly on Monday
  workflow_dispatch:
    inputs:
      update-type:
        description: 'Update type'
        required: true
        type: choice
        options:
          - major
          - minor
          - patch
      target-branch:
        description: 'Target branch for the update PR'
        required: true
        type: string

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: write
  pull-requests: write
  checks: read

jobs:
  check:
    name: Check
    runs-on: ubuntu-latest
    timeout-minutes: 10
    outputs:
      package-managers: ${{ steps.scan.outputs.package-managers }}
      rules: ${{ steps.scan.outputs.rules }}
      total-outdated: ${{ steps.outdated.outputs.total-outdated }}
      minor: ${{ steps.outdated.outputs.minor }}
      patch: ${{ steps.outdated.outputs.patch }}
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ github.event.inputs.target-branch || 'stage-updates' }}
          fetch-depth: 0
      - name: Checkout update branch if exists
        run: |
          BRANCH="goupdate/auto-update-${{ github.event.inputs.update-type || 'minor' }}"
          if git ls-remote --heads origin "$BRANCH" | grep -q "$BRANCH"; then
            echo "Checking out existing branch: $BRANCH"
            git checkout "$BRANCH"
          else
            echo "No existing branch, using base branch"
          fi
      - uses: Utdanningsdirektoratet/dit-github-actions/goupdate/install@v1
      - uses: Utdanningsdirektoratet/dit-github-actions/goupdate/scan@v1
        id: scan
      - uses: Utdanningsdirektoratet/dit-github-actions/github/runtimes@v1
        with:
          node-version: ${{ contains(steps.scan.outputs.package-managers, 'js') && '22' || '' }}
          node-pms: ${{ steps.scan.outputs.rules }}
      - uses: Utdanningsdirektoratet/dit-github-actions/goupdate/outdated@v1
        id: outdated

  update:
    name: Update
    runs-on: ubuntu-latest
    timeout-minutes: 30
    needs: check
    outputs:
      has-changes: ${{ steps.update.outputs.has-changes }}
      branch-name: ${{ steps.update.outputs.branch-name }}
    #if: >-
    #  ((github.event.inputs.update-type || 'minor') == 'major' && needs.check.outputs['total-outdated'] > 0) ||
    #  ((github.event.inputs.update-type || 'minor') == 'minor' && (needs.check.outputs.minor > 0 || needs.check.outputs.patch > 0)) ||
    #  ((github.event.inputs.update-type || 'minor') == 'patch' && needs.check.outputs.patch > 0)
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ github.event.inputs.target-branch || 'stage-updates' }}
          fetch-depth: 0
      - uses: Utdanningsdirektoratet/dit-github-actions/goupdate/install@v1
      - uses: Utdanningsdirektoratet/dit-github-actions/github/runtimes@v1
        with:
          node-version: ${{ contains(needs.check.outputs.package-managers, 'js') && '22' || '' }}
          node-pms: ${{ needs.check.outputs.rules }}
      - uses: Utdanningsdirektoratet/dit-github-actions/goupdate/update@v1
        id: update
        with:
          update-type: ${{ github.event.inputs.update-type || 'minor' }}
          base-branch: ${{ github.event.inputs.target-branch || 'stage-updates' }}

  pr:
    name: Pull Request
    runs-on: ubuntu-latest
    timeout-minutes: 10
    needs: [check, update]
    #if: needs.update.outputs.has-changes == 'true'
    steps:
      - uses: actions/checkout@v4
      - name: Get date
        id: date
        run: echo "date=$(date +'%Y-%m-%d')" >> "$GITHUB_OUTPUT"
      - name: Generate PR body
        id: body
        env:
          UPDATE_TYPE: ${{ github.event.inputs.update-type || 'minor' }}
          TOTAL: ${{ needs.check.outputs.total-outdated }}
          MINOR: ${{ needs.check.outputs.minor }}
          PATCH: ${{ needs.check.outputs.patch }}
          BRANCH: ${{ needs.update.outputs.branch-name }}
          BASE: ${{ github.event.inputs.target-branch || 'stage-updates' }}
          RUN_URL: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
        run: |
          {
            echo "body<<EOF"
            echo "## Summary"
            echo ""
            echo "- **Update type:** $UPDATE_TYPE"
            echo "- **Packages updated:** $TOTAL total ($MINOR minor, $PATCH patch)"
            echo "- **Details:** [View workflow run]($RUN_URL)"
            echo ""
            echo "## Changes"
            echo ""
            echo "[Compare changes](/${{ github.repository }}/compare/${BASE}...${BRANCH})"
            echo ""
            echo "---"
            echo "*Auto-generated by GoUpdate*"
            echo "EOF"
          } >> "$GITHUB_OUTPUT"
      - uses: Utdanningsdirektoratet/dit-github-actions/github/pr@v1
        with:
          app-id: ${{ secrets.GOUPDATE_APP_ID }}
          app-private-key: ${{ secrets.GOUPDATE_APP_PRIVATE_KEY }}
          title: "GoUpdate: ${{ github.event.inputs.update-type || 'minor' }} (${{ steps.date.outputs.date }})"
          body: ${{ steps.body.outputs.body }}
          base: ${{ github.event.inputs.target-branch || 'stage-updates' }}
          head: ${{ needs.update.outputs.branch-name }}
          merge: true
          wait-for-checks: 300
          notify: '@AjXUdir'
