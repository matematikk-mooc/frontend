name: GoUpdate - Auto Update

on:
  push:
    branches:
      - main # Only for testing purposes, normal use is via schedule or manual dispatch
  schedule:
    - cron: '0 0 * * 1' # Weekly on Monday
  workflow_dispatch:
    inputs:
      update-type:
        description: 'Update type'
        required: true
        type: choice
        options:
          - major
          - minor
          - patch
      base-branch:
        description: 'Base branch to update from and open PRs against'
        required: true
        type: string

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: write
  pull-requests: write
  checks: read

jobs:
  check:
    name: Check
    runs-on: ubuntu-latest
    timeout-minutes: 10
    outputs:
      package-managers: ${{ steps.scan.outputs.package-managers }}
      rules: ${{ steps.scan.outputs.rules }}
      total-outdated: ${{ steps.outdated.outputs.total-outdated }}
      major: ${{ steps.outdated.outputs.major }}
      minor: ${{ steps.outdated.outputs.minor }}
      patch: ${{ steps.outdated.outputs.patch }}
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ github.event.inputs.base-branch || 'main' }}
          fetch-depth: 0
      - uses: Utdanningsdirektoratet/dit-github-actions/git/checkout
        with:
          branch: goupdate/auto-update-${{ github.event.inputs.update-type || 'minor' }}
          source-branch: ${{ github.event.inputs.base-branch || 'main' }}
          create-branch: 'false'
      - uses: Utdanningsdirektoratet/dit-github-actions/goupdate/install
      - uses: Utdanningsdirektoratet/dit-github-actions/goupdate/scan
        id: scan
      - uses: Utdanningsdirektoratet/dit-github-actions/github/runtimes
        with:
          node-version: ${{ contains(steps.scan.outputs.package-managers, 'js') && '22' || '' }}
          node-pms: ${{ steps.scan.outputs.rules }}
      - uses: Utdanningsdirektoratet/dit-github-actions/goupdate/outdated
        id: outdated

  update:
    name: Update
    runs-on: ubuntu-latest
    timeout-minutes: 30
    needs: check
    outputs:
      has-changes: ${{ steps.update.outputs.has-changes }}
      branch-name: ${{ steps.checkout-branch.outputs.branch-name }}
      partial-failure: ${{ steps.update.outputs.partial-failure }}
      diverged: ${{ steps.checkout-branch.outputs.diverged }}
    if: >-
      ((github.event.inputs.update-type || 'minor') == 'major' && fromJSON(needs.check.outputs['total-outdated']) > 0) ||
      ((github.event.inputs.update-type || 'minor') == 'minor' && (fromJSON(needs.check.outputs.minor) > 0 || fromJSON(needs.check.outputs.patch) > 0)) ||
      ((github.event.inputs.update-type || 'minor') == 'patch' && fromJSON(needs.check.outputs.patch) > 0)
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ github.event.inputs.base-branch || 'main' }}
          fetch-depth: 0
      - uses: Utdanningsdirektoratet/dit-github-actions/goupdate/install
      - uses: Utdanningsdirektoratet/dit-github-actions/github/runtimes
        with:
          node-version: ${{ contains(needs.check.outputs.package-managers, 'js') && '22' || '' }}
          node-pms: ${{ needs.check.outputs.rules }}
      - uses: Utdanningsdirektoratet/dit-github-actions/git/checkout
        id: checkout-branch
        with:
          branch: goupdate/auto-update-${{ github.event.inputs.update-type || 'minor' }}
          source-branch: ${{ github.event.inputs.base-branch || 'main' }}

      - uses: Utdanningsdirektoratet/dit-github-actions/github/clone
        with:
          repository: matematikk-mooc/frontend-react
          path: .tests_playwright
          app-id: ${{ secrets.GOUPDATE_APP_ID }}
          app-private-key: ${{ secrets.GOUPDATE_APP_PRIVATE_KEY }}
      - uses: Utdanningsdirektoratet/dit-github-actions/js/install
        with:
          working-directory: .tests_playwright
      - uses: Utdanningsdirektoratet/dit-github-actions/js/playwright
        with:
          working-directory: .tests_playwright
          browsers: chromium

      - uses: Utdanningsdirektoratet/dit-github-actions/js/install
      - uses: Utdanningsdirektoratet/dit-github-actions/js/playwright
        with:
          browsers: chromium
      - uses: Utdanningsdirektoratet/dit-github-actions/goupdate/update
        id: update
        with:
          update-type: ${{ github.event.inputs.update-type || 'minor' }}
        env:
          APP_ENV: development
          TEST_CANVAS_LOCAL_THEME: 'true'
          TEST_CANVAS_CHROMIUM_USERNAME: ${{ vars.TEST_CANVAS_CHROMIUM_USERNAME }}
          TEST_CANVAS_CHROMIUM_PASSWORD: ${{ secrets.TEST_CANVAS_CHROMIUM_PASSWORD }}
      - uses: Utdanningsdirektoratet/dit-github-actions/git/commit
        if: steps.update.outputs.has-changes == 'true'
        with:
          message: "GoUpdate: ${{ github.event.inputs.update-type || 'minor' }} update"
      - uses: Utdanningsdirektoratet/dit-github-actions/github/push
        if: steps.update.outputs.has-changes == 'true'
        with:
          app-id: ${{ secrets.GOUPDATE_APP_ID }}
          app-private-key: ${{ secrets.GOUPDATE_APP_PRIVATE_KEY }}
          branch: ${{ steps.checkout-branch.outputs.branch-name }}

  pr:
    name: Pull Request
    runs-on: ubuntu-latest
    timeout-minutes: 10
    needs: [check, update]
    if: needs.update.outputs.has-changes == 'true'
    steps:
      - uses: actions/checkout@v4
      - name: Generate PR body
        id: body
        env:
          UPDATE_TYPE: ${{ github.event.inputs.update-type || 'minor' }}
          TOTAL: ${{ needs.check.outputs.total-outdated }}
          MAJOR: ${{ needs.check.outputs.major }}
          MINOR: ${{ needs.check.outputs.minor }}
          PATCH: ${{ needs.check.outputs.patch }}
          BRANCH: ${{ needs.update.outputs.branch-name }}
          BASE: ${{ github.event.inputs.base-branch || 'main' }}
          RUN_URL: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
          PARTIAL_FAILURE: ${{ needs.update.outputs.partial-failure }}
          DIVERGED: ${{ needs.update.outputs.diverged }}
          REPO: ${{ github.repository }}
        run: |
          {
            echo "body<<EOF"

            if [ "$PARTIAL_FAILURE" = "true" ]; then
              echo "> [!WARNING]"
              echo "> Some updates failed. Review the [workflow run]($RUN_URL) for details."
              echo ""
            fi

            if [ "$DIVERGED" = "true" ]; then
              echo "> [!WARNING]"
              echo "> Update branch has diverged from \`$BASE\`. Manual rebase or merge may be required."
              echo ""
            fi

            echo "## Summary"
            echo ""
            echo "- **Update type:** $UPDATE_TYPE"
            echo "- **Packages outdated:** $TOTAL ($MAJOR major, $MINOR minor, $PATCH patch)"
            echo "- **Details:** [View workflow run]($RUN_URL)"
            echo ""
            echo "## Changes"
            echo ""
            echo "[Compare changes](/${REPO}/compare/${BASE}...${BRANCH})"
            echo ""
            echo "---"
            echo "*Auto-generated by GoUpdate*"
            echo "EOF"
          } >> "$GITHUB_OUTPUT"
      - uses: Utdanningsdirektoratet/dit-github-actions/github/pr
        id: pr
        with:
          app-id: ${{ secrets.GOUPDATE_APP_ID }}
          app-private-key: ${{ secrets.GOUPDATE_APP_PRIVATE_KEY }}
          title: "GoUpdate: ${{ github.event.inputs.update-type || 'minor' }} ({date})"
          body: ${{ steps.body.outputs.body }}
          base: ${{ github.event.inputs.base-branch || 'main' }}
          head: ${{ needs.update.outputs.branch-name }}
      - name: Notify partial failure
        if: needs.update.outputs.partial-failure == 'true'
        env:
          GH_TOKEN: ${{ github.token }}
          PR_NUMBER: ${{ steps.pr.outputs.pr-number }}
        run: |
          gh pr comment "$PR_NUMBER" --body "Not all updates succeeded. Auto-merge skipped. @ajxudir please review."
          echo "::warning::Partial failure â€” PR created but auto-merge skipped"
      - uses: Utdanningsdirektoratet/dit-github-actions/github/pr-merge
        if: needs.update.outputs.partial-failure != 'true'
        with:
          app-id: ${{ secrets.GOUPDATE_APP_ID }}
          app-private-key: ${{ secrets.GOUPDATE_APP_PRIVATE_KEY }}
          pr-number: ${{ steps.pr.outputs.pr-number }}
          wait-for-checks: 300
          notify: '@ajxudir'
