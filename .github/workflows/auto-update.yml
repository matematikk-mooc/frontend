# Auto Update Workflow
# Automated dependency updates via PR
#
# Supported: npm, yarn, pnpm, composer, pip, pipenv, go mod, nuget
# Enable multiple package managers by setting ENABLE_* to 'true'

name: Auto Update Dependencies

on:
  schedule:
    - cron: '0 0 * * 1'  # Weekly on Monday
  workflow_dispatch:
    inputs:
      mode:
        description: 'Mode'
        default: 'update'
        type: choice
        options: [check-only, update]
      update-type:
        description: 'Update type'
        default: 'minor'
        type: choice
        options: [minor, patch]

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: false

# ============================================================================
# CONFIGURATION
# ============================================================================
env:
  GOUPDATE_REPO: 'ajxudir/goupdate'

  # Package Managers (set to 'true' to enable)
  ENABLE_NPM: 'false'
  ENABLE_YARN: 'false'
  ENABLE_PNPM: 'true'
  ENABLE_COMPOSER: 'false'
  ENABLE_PIP: 'false'
  ENABLE_PIPENV: 'false'
  ENABLE_GO: 'false'
  ENABLE_NUGET: 'false'

  # Versions
  NODE_VERSION: '20'
  PHP_VERSION: '8.2'
  PYTHON_VERSION: '3.12'
  GO_VERSION: '1.24'
  DOTNET_VERSION: '8.0'

  # Branches - {type} will be replaced with minor/patch
  UPDATE_BRANCH: 'goupdate/{type}'
  TARGET_BRANCH: 'stage-updates'

  # PR
  PR_TITLE: 'GoUpdate: Auto update - {type} ({date})'
  TEST_COMMAND: 'pnpm run build'
  EXCLUDE_PACKAGES: ''

permissions:
  contents: write
  pull-requests: write

jobs:
  update:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # Determine what to run
      - name: Configure
        id: config
        run: |
          # Build rules list
          RULES=""
          [ "$ENABLE_NPM" = "true" ] && RULES="${RULES}npm,"
          [ "$ENABLE_YARN" = "true" ] && RULES="${RULES}yarn,"
          [ "$ENABLE_PNPM" = "true" ] && RULES="${RULES}pnpm,"
          [ "$ENABLE_COMPOSER" = "true" ] && RULES="${RULES}composer,"
          [ "$ENABLE_PIP" = "true" ] && RULES="${RULES}requirements,"
          [ "$ENABLE_PIPENV" = "true" ] && RULES="${RULES}pipfile,"
          [ "$ENABLE_GO" = "true" ] && RULES="${RULES}mod,"
          [ "$ENABLE_NUGET" = "true" ] && RULES="${RULES}nuget,"
          RULES="${RULES%,}"

          # Detect needed runtimes
          USE_NODE="false"
          USE_PHP="false"
          USE_PYTHON="false"
          USE_GO="false"
          USE_DOTNET="false"
          [[ "$ENABLE_NPM" = "true" || "$ENABLE_YARN" = "true" || "$ENABLE_PNPM" = "true" ]] && USE_NODE="true"
          [ "$ENABLE_COMPOSER" = "true" ] && USE_PHP="true"
          [[ "$ENABLE_PIP" = "true" || "$ENABLE_PIPENV" = "true" ]] && USE_PYTHON="true"
          [ "$ENABLE_GO" = "true" ] && USE_GO="true"
          [ "$ENABLE_NUGET" = "true" ] && USE_DOTNET="true"

          # Mode
          EVENT="${{ github.event_name }}"
          MODE="${{ inputs.mode }}"
          TYPE="${{ inputs.update-type }}"
          [ "$EVENT" = "schedule" ] && MODE="update" && TYPE="minor"
          [ -z "$TYPE" ] && TYPE="minor"

          echo "rules=$RULES" >> $GITHUB_OUTPUT
          echo "use_node=$USE_NODE" >> $GITHUB_OUTPUT
          echo "use_php=$USE_PHP" >> $GITHUB_OUTPUT
          echo "use_python=$USE_PYTHON" >> $GITHUB_OUTPUT
          echo "use_go=$USE_GO" >> $GITHUB_OUTPUT
          echo "use_dotnet=$USE_DOTNET" >> $GITHUB_OUTPUT
          echo "mode=$MODE" >> $GITHUB_OUTPUT
          echo "type=$TYPE" >> $GITHUB_OUTPUT
          echo "Rules: $RULES"

      # Setup runtimes
      - name: Setup Node.js
        if: steps.config.outputs.use_node == 'true'
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Enable corepack
        if: env.ENABLE_YARN == 'true' || env.ENABLE_PNPM == 'true'
        run: corepack enable

      - name: Setup PHP
        if: steps.config.outputs.use_php == 'true'
        uses: shivammathur/setup-php@v2
        with:
          php-version: ${{ env.PHP_VERSION }}

      - name: Setup Python
        if: steps.config.outputs.use_python == 'true'
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Setup Go
        if: steps.config.outputs.use_go == 'true'
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}

      - name: Setup .NET
        if: steps.config.outputs.use_dotnet == 'true'
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      # Install dependencies
      - if: env.ENABLE_NPM == 'true'
        run: npm ci
      - if: env.ENABLE_YARN == 'true'
        run: yarn install --frozen-lockfile
      - if: env.ENABLE_PNPM == 'true'
        run: pnpm install --frozen-lockfile
      - if: env.ENABLE_COMPOSER == 'true'
        run: composer install --no-interaction
      - if: env.ENABLE_PIP == 'true'
        run: pip install -r requirements.txt
      - if: env.ENABLE_PIPENV == 'true'
        run: pip install pipenv && pipenv install
      - if: env.ENABLE_NUGET == 'true'
        run: dotnet restore

      # Install goupdate
      - name: Install goupdate
        uses: ./.github/actions/_goupdate-install
        with:
          goupdate-repo: ${{ env.GOUPDATE_REPO }}
          github-token: ${{ secrets.GITHUB_TOKEN }}

      # Check for updates
      - name: Check for updates
        id: check
        env:
          RULES: ${{ steps.config.outputs.rules }}
          EXCLUDE: ${{ env.EXCLUDE_PACKAGES }}
        run: |
          EXCLUDE_FLAG=""
          [ -n "$EXCLUDE" ] && EXCLUDE_FLAG="-e $EXCLUDE"

          # Get JSON output
          JSON=$(goupdate outdated -r "$RULES" -o json $EXCLUDE_FLAG 2>&1) || true

          # Parse summary
          TOTAL=$(echo "$JSON" | jq -r '.summary.total_packages // 0')
          OUTDATED=$(echo "$JSON" | jq -r '.summary.outdated_packages // 0')
          HAS_MAJOR=$(echo "$JSON" | jq -r '.summary.has_major // 0')
          HAS_MINOR=$(echo "$JSON" | jq -r '.summary.has_minor // 0')
          HAS_PATCH=$(echo "$JSON" | jq -r '.summary.has_patch // 0')

          # Determine if we have applicable updates
          HAS_UPDATES="false"
          [ "$HAS_MINOR" -gt 0 ] || [ "$HAS_PATCH" -gt 0 ] && HAS_UPDATES="true"

          # Major-only check
          HAS_MAJOR_ONLY="false"
          [ "$HAS_MAJOR" -gt 0 ] && [ "$HAS_MINOR" -eq 0 ] && [ "$HAS_PATCH" -eq 0 ] && HAS_MAJOR_ONLY="true"

          echo "has_updates=$HAS_UPDATES" >> $GITHUB_OUTPUT
          echo "has_major_only=$HAS_MAJOR_ONLY" >> $GITHUB_OUTPUT
          echo "has_major=$HAS_MAJOR" >> $GITHUB_OUTPUT
          echo "has_minor=$HAS_MINOR" >> $GITHUB_OUTPUT
          echo "has_patch=$HAS_PATCH" >> $GITHUB_OUTPUT

          # Show summary
          echo ""
          echo "══════════════════════════════════════════════════════════════"
          echo "Update Summary: $OUTDATED/$TOTAL packages outdated"
          echo "  Major: $HAS_MAJOR | Minor: $HAS_MINOR | Patch: $HAS_PATCH"
          if [ "$HAS_MAJOR" -gt 0 ]; then
            echo ""
            echo "⚠️  $HAS_MAJOR package(s) have MAJOR updates available (not auto-applied)"
          fi
          echo "══════════════════════════════════════════════════════════════"

      # Fail on major-only
      - name: Check major-only
        if: steps.check.outputs.has_major_only == 'true'
        run: |
          echo "::error::Only major updates available - manual review required"
          echo ""
          echo "No minor/patch updates to apply. ${{ steps.check.outputs.has_major }} major update(s) need manual review."
          echo "Add packages to 'ignore' in .goupdate.yml to skip them."
          exit 1

      # Apply updates
      - name: Apply updates
        id: update
        if: steps.config.outputs.mode == 'update' && steps.check.outputs.has_updates == 'true'
        env:
          RULES: ${{ steps.config.outputs.rules }}
          TYPE: ${{ steps.config.outputs.type }}
          EXCLUDE: ${{ env.EXCLUDE_PACKAGES }}
        run: |
          EXCLUDE_FLAG=""
          [ -n "$EXCLUDE" ] && EXCLUDE_FLAG="-e $EXCLUDE"

          TYPE_FLAG="--minor"
          [ "$TYPE" = "patch" ] && TYPE_FLAG="--patch"

          # Stream output live while also capturing to file
          # This ensures developers see progress in real-time
          goupdate update -r "$RULES" $TYPE_FLAG $EXCLUDE_FLAG --continue-on-fail -y 2>&1 | tee /tmp/update-output.txt
          OUTPUT=$(cat /tmp/update-output.txt)

          # Store for PR body
          {
            echo "output<<EOF"
            echo "$OUTPUT"
            echo "EOF"
          } >> $GITHUB_OUTPUT

      # Create PR
      - name: Create PR
        if: steps.config.outputs.mode == 'update' && steps.check.outputs.has_updates == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          TYPE: ${{ steps.config.outputs.type }}
          OUTPUT: ${{ steps.update.outputs.output }}
          HAS_MAJOR: ${{ steps.check.outputs.has_major }}
        run: |
          # Check for changes
          if git diff --quiet; then
            echo "No changes to commit"
            exit 0
          fi

          # Run tests if configured
          if [ -n "$TEST_COMMAND" ]; then
            echo "Running tests..."
            $TEST_COMMAND || true
          fi

          # Setup branches - substitute {type} in branch name
          BRANCH=$(echo "$UPDATE_BRANCH" | sed "s/{type}/$TYPE/g")
          git fetch origin "$TARGET_BRANCH" 2>/dev/null || git branch "$TARGET_BRANCH" && git push -u origin "$TARGET_BRANCH"
          git checkout -B "$BRANCH" origin/"$TARGET_BRANCH" 2>/dev/null || git checkout -B "$BRANCH"

          # Commit
          DATE=$(date -u +%Y-%m-%d)
          TYPE_CAP=$(echo "$TYPE" | sed 's/\b\(.\)/\u\1/')
          TITLE=$(echo "$PR_TITLE" | sed "s/{date}/$DATE/g" | sed "s/{type}/$TYPE_CAP/g")

          git add -A
          git commit -m "$TITLE"
          git push -u origin "$BRANCH" --force

          # Build PR body
          BODY="## Dependency Updates

          \`\`\`
          $OUTPUT
          \`\`\`"

          if [ "$HAS_MAJOR" -gt 0 ]; then
            BODY="$BODY

          > ⚠️ **$HAS_MAJOR major update(s) available** - not auto-applied, review manually"
          fi

          # Create PR
          gh pr create --title "$TITLE" --body "$BODY" --base "$TARGET_BRANCH" --head "$BRANCH" 2>/dev/null || \
          gh pr edit --title "$TITLE" --body "$BODY"
